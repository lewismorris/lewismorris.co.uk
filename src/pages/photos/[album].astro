---
import { getCollection, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  let albums: CollectionEntry<'photos'>[] = [];
  try {
    albums = await getCollection('photos');
  } catch {
    albums = [];
  }

  return albums
    .filter((album) => !album.data.hidden)
    .map((album) => ({
      params: { album: album.slug },
      props: { album }
    }));
}

const { album } = Astro.props;

const sidecarModules = import.meta.glob('../../content/photos-data/*.json', { eager: true });
const imageModules = import.meta.glob('/src/assets/photos/**/*.{jpg,jpeg,png,webp,heic,JPG,JPEG,PNG,WEBP,HEIC,avif,AVIF}', {
  eager: true
});

type PhotoMeta = {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  capturedAt?: string;
  iso?: number;
  aperture?: string;
  shutter?: string;
  camera?: string;
  lens?: string;
};

const sidecarPath = `../../content/photos-data/${album.slug}.json`;
const sidecar = sidecarModules[sidecarPath] as { default?: { photos?: PhotoMeta[] }; photos?: PhotoMeta[] } | undefined;
const sidecarPayload = sidecar?.default ?? sidecar;
const photos = Array.isArray(sidecarPayload?.photos) ? sidecarPayload.photos : [];

function imageMetaFor(src: string) {
  const mod = imageModules[src] as { default?: ImageMetadata } | undefined;
  return mod?.default;
}

function exifRows(photo: PhotoMeta) {
  return [
    ['ISO', photo.iso],
    ['F-stop', photo.aperture],
    ['Shutter', photo.shutter],
    ['Camera', photo.camera],
    ['Lens', photo.lens]
  ].filter(([, value]) => value !== undefined && value !== '');
}
---

<Layout title={album.data.title}>
  <main class="max-w-6xl mx-auto space-y-8">
    <header class="space-y-3">
      <a href="/photos" class="inline-block">&larr; Back to photos</a>
      <h1 class="text-4xl font-medium">{album.data.title}</h1>
      {album.data.description && <p class="text-neutral-700 dark:text-neutral-300">{album.data.description}</p>}
    </header>

    {
      photos.length === 0 ? (
        <p>No photos found for this album yet. Run <code>npm run photos:sync</code>.</p>
      ) : (
        <>
          <ul class="columns-1 sm:columns-2 lg:columns-3 gap-4 [column-fill:_balance]">
            {photos.map((photo, index) => {
              const imageMeta = imageMetaFor(photo.src);
              if (!imageMeta) {
                return null;
              }

              return (
                <li class="mb-4 break-inside-avoid">
                  <button
                    type="button"
                    class="block w-full cursor-zoom-in border-0 bg-transparent p-0"
                    data-dialog-open={`photo-dialog-${index}`}
                    aria-label={`Open ${photo.alt}`}
                  >
                    <Image
                      src={imageMeta}
                      alt={photo.alt}
                      widths={[480, 800, 1200]}
                      sizes="(min-width: 1024px) 30vw, (min-width: 640px) 45vw, 100vw"
                      class="w-full h-auto rounded-lg"
                      loading="lazy"
                      fetchpriority="low"
                    />
                  </button>
                </li>
              );
            })}
          </ul>

          {photos.map((photo, index) => {
            const imageMeta = imageMetaFor(photo.src);
            if (!imageMeta) {
              return null;
            }

            const rows = exifRows(photo);

            return (
              <dialog
                id={`photo-dialog-${index}`}
                class="photo-dialog fixed inset-0 m-0 h-screen w-screen max-h-none max-w-none border-0 bg-transparent p-0 [&::backdrop]:bg-black/75"
                aria-label={photo.alt}
              >
                <div
                  class="absolute inset-0 -z-10 cursor-pointer"
                  data-dialog-backdrop
                  aria-hidden="true"
                />
                <div
                  class="relative mx-auto my-[5vh] grid max-h-[90vh] w-[calc(100vw-1.5rem)] gap-3 sm:w-[calc(100vw-4rem)] lg:w-[min(1400px,calc(100vw-4rem))]"
                  data-dialog-container
                >
                  <button
                    type="button"
                    class="absolute -top-7 right-0 cursor-pointer border-0 bg-transparent text-white"
                    data-dialog-close
                    aria-label="Close image"
                  >
                    X
                  </button>

                  <Image
                    src={imageMeta}
                    alt={photo.alt}
                    widths={[960, 1400, 2000]}
                    sizes="90vw"
                    class="block max-h-[90vh] w-full rounded-lg object-contain"
                  />

                  {(photo.capturedAt || rows.length > 0) && (
                    <div class="rounded-lg bg-white p-3 text-[#111]">
                      {photo.capturedAt && (
                        <p class="text-neutral-700">
                          Captured {new Date(photo.capturedAt).toLocaleString()}
                        </p>
                      )}

                      {rows.length > 0 && (
                        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">
                          {rows.map(([label, value]) => (
                            <div>
                              <dt class="text-neutral-500 dark:text-neutral-400">{label}</dt>
                              <dd>{String(value)}</dd>
                            </div>
                          ))}
                        </dl>
                      )}
                    </div>
                  )}
                </div>
              </dialog>
            );
          })}
        </>
      )
    }
  </main>
</Layout>

<script>
  function initPhotoDialogs() {
    const root = document.querySelector('main');
    if (!root || root.getAttribute('data-dialogs-initialized') === 'true') {
      return;
    }

    root.setAttribute('data-dialogs-initialized', 'true');

    function syncScrollLock() {
      const hasOpenDialog = root?.querySelector('dialog[open]') !== null;
      document.documentElement.style.overflow = hasOpenDialog ? 'hidden' : '';
      document.body.style.overflow = hasOpenDialog ? 'hidden' : '';
    }

    root.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;

      const opener = target.closest('[data-dialog-open]');
      if (opener instanceof HTMLElement) {
        const dialogId = opener.getAttribute('data-dialog-open');
        if (!dialogId) return;

        const dialog = document.getElementById(dialogId);
        if (dialog instanceof HTMLDialogElement && typeof dialog.showModal === 'function') {
          dialog.showModal();
          syncScrollLock();
        }
        return;
      }

      const closer = target.closest('[data-dialog-close]');
      if (closer instanceof HTMLElement) {
        const dialog = closer.closest('dialog');
        if (dialog instanceof HTMLDialogElement) {
          dialog.close();
          syncScrollLock();
        }
      }
    });

    const dialogs = root.querySelectorAll('.photo-dialog');
    for (const dialog of dialogs) {
      if (!(dialog instanceof HTMLDialogElement)) continue;

      dialog.addEventListener('click', (event) => {
        if (event.target === dialog) {
          dialog.close();
          syncScrollLock();
        }
      });

      dialog.addEventListener('close', syncScrollLock);
      dialog.addEventListener('cancel', syncScrollLock);
    }
  }

  document.addEventListener('astro:page-load', initPhotoDialogs);
  initPhotoDialogs();
</script>
